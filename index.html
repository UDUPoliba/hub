<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UDU Hub</title>

    <style>
        @font-face {
            font-family: 'Argentum Sans';
            src: url('./fonts/ArgentumSans-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Argentum Sans', sans-serif;
            background: #f9f9f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            background: #efdd61;
            padding: 2em;
            border-radius: 1em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        h1 {
            margin: 0 0 0.75em;
            color: #333;
            font-size: 2em;
            line-height: 1;
            text-align: center;
        }

        h2 {
            margin-bottom: 1em;
            color: #333;
            font-size: 1.5em;
        }

        input {
            padding: 0.8em;
            font-size: 1em;
            width: 90%;
            border: 1px solid #333;
            border-radius: 0.5em;
            margin-bottom: 1em;
            color: #333;
            align-self: center;
        }

        input::placeholder {
            color: #333;
            opacity: 1;
        }

        button {
            padding: 0.8em 1.2em;
            font-size: 1em;
            background-color: #d92d28;
            color: white;
            border: none;
            border-radius: 0.5em;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            letter-spacing: 0.5px;
            align-self: center;
        }

        button:hover {
            background-color: #b8211d;
        }

        .btn-back {
            background: #333;
        }

        .btn-back:hover {
            background: #111;
        }

        strong {
            color: #d92d28;
        }

        small {
            display: block;
            color: #666;
            margin-top: 0.3em;
        }
    </style>
</head>
<body>
<h1 id="mainHeader">DRIVE MATERIALI, ORARI E GRUPPI WHATSAPP by UDU ‚òÄÔ∏è</h1>
<div class="container">
    <h2 id="title">Scegli il dipartimento</h2>

    <div id="actions" style="display:flex; flex-direction:column; gap:0.75em;"></div>

    <div id="formArea" style="display:none; margin-top: 0.5em; text-align:left;">
        <label for="course" style="display:block; margin: 0.75em 0 0.25em;">Corso di laurea *</label>
        <select id="course" name="course" style="width:100%; padding:0.8em; border:1px solid #333; border-radius:0.5em;">
            <option value="">Seleziona Corso</option>
        </select>

        <div id="yearWrap">
            <label id="yearLabel" for="year" style="display:block; margin: 0.75em 0 0.25em;">Anno *</label>
            <select id="year" name="year" style="width:100%; padding:0.8em; border:1px solid #333; border-radius:0.5em;">
                <option value="">Seleziona Anno</option>
            </select>
        </div>

        <button id="continueBtn" style="margin-top: 1em;">Continua</button>
        <button id="backBtn" style="margin-top: 0.5em; background:#333;">Indietro</button>
    </div>

    <div id="pageArea" style="display:none; margin-top: 0.75em; text-align:left;"></div>

    <img src="logo.svg" alt="Logo UDU Hub"
         style="margin-top: 2em; max-width: 20%; height: auto; align-self: center;"/>
</div>

<script>
    const state = {
        data: null,
        deptKey: null,
        mode: null, // null | "ORARI" | "GRUPPI"
        selectedCourse: null,
        selectedYearObj: null,
    };

    const el = {
        title: document.getElementById('title'),
        actions: document.getElementById('actions'),
        formArea: document.getElementById('formArea'),
        course: document.getElementById('course'),
        year: document.getElementById('year'),
        yearWrap: document.getElementById('yearWrap'),
        continueBtn: document.getElementById('continueBtn'),
        backBtn: document.getElementById('backBtn'),
        pageArea: document.getElementById('pageArea'),
        mainHeader: document.getElementById('mainHeader'),
    };

    function clear(node) {
        while (node.firstChild) node.removeChild(node.firstChild);
    }

    function showMainHeader(show) {
        if (!el.mainHeader) return;
        el.mainHeader.style.display = show ? '' : 'none';
    }

    function showTopLogo(show) {
        // optional helper reserved for future; no-op for now
    }

    function makeButton(label, onClick) {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = label;
        b.addEventListener('click', onClick);
        return b;
    }

    function makeBackButton(onClick) {
        const b = makeButton('Indietro', onClick);
        b.classList.add('btn-back');
        return b;
    }

    function makeDriveButton(onClick) {
        const b = document.createElement('button');
        b.type = 'button';
        b.addEventListener('click', onClick);
        b.innerHTML = `DRIVE <span aria-hidden="true" style="margin-left:0.5em;">üîó</span>`;
        return b;
    }

    function makeLinkButton(label, href) {
        const b = document.createElement('button');
        b.type = 'button';
        b.addEventListener('click', () => {
            if (href && String(href).trim()) {
                window.location.href = href;
                return;
            }
            alert('Link non disponibile.');
        });
        b.innerHTML = `${escapeHtml(label)} <span aria-hidden="true" style="margin-left:0.5em;">üîó</span>`;
        return b;
    }

    function getDepartmentsMap() {
        // Supporta:
        // 1) { data: { "DIP": ... } }
        // 2) { data: [ { "DIP": ... } ] }
        if (!state.data) return {};
        const d = state.data.data;

        if (d && typeof d === 'object' && !Array.isArray(d)) return d;
        if (Array.isArray(d)) return d[0] || {};

        return {};
    }

    function getDeptObj(deptKey) {
        const map = getDepartmentsMap();
        const v = map[deptKey];

        // Support: "DIP": { drive, courses }
        if (v && typeof v === 'object' && !Array.isArray(v)) {
            return {
                drive: typeof v.drive === 'string' ? v.drive : "",
                courses: Array.isArray(v.courses) ? v.courses : [],
            };
        }

        // Legacy support: "DIP": [ {id,name,years}, ... ]
        if (Array.isArray(v)) {
            return { drive: "", courses: v };
        }

        return { drive: "", courses: [] };
    }

    function renderDeptButtons() {
        state.deptKey = null;
        state.mode = null;
        showMainHeader(true);

        el.title.textContent = 'Scegli il dipartimento';
        el.formArea.style.display = 'none';
        el.pageArea.style.display = 'none';
        clear(el.pageArea);

        clear(el.actions);

        const map = getDepartmentsMap();
        const deptKeys = Object.keys(map);

        deptKeys.sort((a, b) => a.localeCompare(b, 'it'));

        deptKeys.forEach((deptKey) => {
            el.actions.appendChild(makeButton(deptKey, () => renderDeptActions(deptKey)));
        });
    }

    function renderDeptActions(deptKey) {
        state.deptKey = deptKey;
        state.mode = null;
        showMainHeader(false);

        el.title.textContent = deptKey;
        el.formArea.style.display = 'none';
        el.pageArea.style.display = 'none';
        clear(el.pageArea);

        clear(el.actions);

        const dept = getDeptObj(deptKey);

        // DRIVE
        el.actions.appendChild(makeDriveButton(() => {
            if (dept.drive && dept.drive.trim()) {
                window.location.href = dept.drive;
                return;
            }
            alert('Link DRIVE non impostato per questo dipartimento.');
        }));

        // ORARI
        el.actions.appendChild(makeButton('ORARI', () => {
            state.mode = 'ORARI';
            renderCourseYearForm();
        }));

        // GRUPPI WZ
        el.actions.appendChild(makeButton('GRUPPI WHATSAPP', () => {
            state.mode = 'GRUPPI';
            renderCourseYearForm();
        }));

        // INDIETRO
        el.actions.appendChild(makeBackButton(() => renderDeptButtons()));
    }

    function renderCourseYearForm() {
        state.selectedCourse = null;
        state.selectedYearObj = null;
        showMainHeader(false);

        el.formArea.style.display = 'block';
        el.pageArea.style.display = 'none';
        clear(el.pageArea);

        // Nascondo tutti i pulsanti "azioni"
        clear(el.actions);

        el.title.textContent = `${state.deptKey} ¬∑ ${state.mode === 'ORARI' ? 'Orari' : 'Gruppi WZ'}`;

        const deptUpper = String(state.deptKey).trim().toUpperCase();
        const isArcod = deptUpper === 'ARCOD';

        // Schema richiesto:
        // - ORARI: solo ARCOD NON chiede l'anno (redirect diretto su time_table)
        // - GRUPPI WZ: TUTTI i corsi chiedono l'anno
        const needsYear = !(isArcod && state.mode === 'ORARI');

        el.yearWrap.style.display = needsYear ? 'block' : 'none';

        // Popola select corsi
        const dept = getDeptObj(state.deptKey);
        const courses = Array.isArray(dept.courses) ? dept.courses : [];

        // reset
        el.course.innerHTML = `<option value="">Seleziona Corso</option>`;
        el.year.innerHTML = `<option value="">Seleziona Anno</option>`;


        courses.forEach((c) => {
            const opt = document.createElement('option');
            opt.value = c.id ?? '';
            opt.textContent = c.name ?? '';
            el.course.appendChild(opt);
        });

        function fillYearsFromCourse(courseObj) {
            el.year.innerHTML = `<option value="">Seleziona Anno</option>`;
            state.selectedYearObj = null;

            // New schema: years is an array of objects [{id, groups:[{name,link}, ...]}, ...]
            if (Array.isArray(courseObj?.years)) {
                // Sort numeric if possible (1,2,3...) but keep stable otherwise
                const yearsList = [...courseObj.years].sort((a, b) => {
                    const ai = parseInt(String(a?.id ?? ''), 10);
                    const bi = parseInt(String(b?.id ?? ''), 10);
                    if (Number.isFinite(ai) && Number.isFinite(bi)) return ai - bi;
                    return String(a?.id ?? '').localeCompare(String(b?.id ?? ''), 'it');
                });

                yearsList.forEach((yObj) => {
                    const opt = document.createElement('option');
                    opt.value = String(yObj?.id ?? '');
                    opt.textContent = String(yObj?.id ?? '');
                    el.year.appendChild(opt);
                });
                return;
            }

            // Backward compatibility: years is an integer max (1..N)
            const maxYears = parseInt(String(courseObj?.years ?? 3), 10);
            const safeMax = Number.isFinite(maxYears) && maxYears > 0 ? maxYears : 3;
            for (let i = 1; i <= safeMax; i++) {
                const y = document.createElement('option');
                y.value = String(i);
                y.textContent = String(i);
                el.year.appendChild(y);
            }
        }

        el.course.onchange = () => {
            const courseId = el.course.value;
            state.selectedCourse = courses.find((c) => (c?.id ?? '') === courseId) || null;

            if (!needsYear) {
                // ORARI + ARCOD: non serve l'anno
                state.selectedYearObj = null;
                return;
            }

            if (!state.selectedCourse) {
                el.year.innerHTML = `<option value="">Seleziona Anno</option>`;
                state.selectedYearObj = null;
                el.yearWrap.style.display = 'block';
                return;
            }

            // Se il corso ha un solo anno disponibile, lo selezioniamo automaticamente e nascondiamo la select.
            const yearsArr = Array.isArray(state.selectedCourse.years) ? state.selectedCourse.years : [];
            if (yearsArr.length === 1) {
                state.selectedYearObj = yearsArr[0] || null;

                // Imposta la select (anche se poi la nascondiamo) per coerenza.
                el.year.innerHTML = `<option value="${escapeHtml(String(state.selectedYearObj?.id ?? ''))}" selected>${escapeHtml(String(state.selectedYearObj?.id ?? ''))}</option>`;

                el.yearWrap.style.display = 'none';
                return;
            }

            // Altrimenti mostriamo la select e popoliamo tutti gli anni.
            el.yearWrap.style.display = 'block';
            fillYearsFromCourse(state.selectedCourse);
        };

        el.year.onchange = () => {
            if (!needsYear) return;
            el.yearWrap.style.display = 'block';

            const yearId = el.year.value;
            const courseObj = state.selectedCourse;

            if (!courseObj) {
                state.selectedYearObj = null;
                return;
            }

            if (Array.isArray(courseObj.years)) {
                state.selectedYearObj = courseObj.years.find((y) => String(y?.id ?? '') === String(yearId)) || null;
            } else {
                // fallback
                state.selectedYearObj = { id: String(yearId), groups: [] };
            }
        };

        el.continueBtn.onclick = (e) => {
            e.preventDefault();

            const courseId = el.course.value;
            const courseName = el.course.selectedOptions[0]?.textContent || '';
            const yearId = needsYear
                ? (state.selectedYearObj?.id ? String(state.selectedYearObj.id) : el.year.value)
                : '';

            if (!courseId) {
                alert('Seleziona un corso.');
                return;
            }
            if (needsYear && !yearId) {
                alert('Seleziona un anno.');
                return;
            }

            // Assicuro selezione corso/anno nello state
            if (!state.selectedCourse) {
                state.selectedCourse = courses.find((c) => (c?.id ?? '') === courseId) || null;
            }
            if (needsYear && !state.selectedYearObj) {
                const yearsArr = Array.isArray(state.selectedCourse?.years) ? state.selectedCourse.years : [];
                if (yearsArr.length === 1) {
                    state.selectedYearObj = yearsArr[0] || null;
                }
            }
            if (needsYear && !state.selectedYearObj) {
                const cObj = state.selectedCourse;
                if (cObj && Array.isArray(cObj.years)) {
                    state.selectedYearObj = cObj.years.find((y) => String(y?.id ?? '') === String(yearId)) || null;
                } else {
                    state.selectedYearObj = { id: String(yearId), groups: [] };
                }
            }

            const payload = {
                courseId,
                courseName,
                year: yearId ? String(yearId) : "",
                yearObj: state.selectedYearObj,
            };

            if (state.mode === 'ORARI') {
                if (isArcod) {
                    const tt = state.selectedCourse?.time_table;
                    if (typeof tt === 'string' && tt.trim()) {
                        window.location.href = tt;
                        return;
                    }
                    alert('Link orari (time_table) non impostato per questo corso.');
                    return;
                }

                // Per ora: per tutti gli altri, non facciamo nulla (placeholder)
                renderOrariPage(payload);
                return;
            }

            // GRUPPI WZ: sempre con anno selezionato
            renderGruppiPage(payload);
        };

        el.backBtn.onclick = (e) => {
            e.preventDefault();
            renderDeptActions(state.deptKey);
        };
    }

    function renderOrariPage({ courseId, courseName, year, yearObj }) {
        showMainHeader(false);
        el.formArea.style.display = 'none';
        el.pageArea.style.display = 'block';
        clear(el.pageArea);

        el.title.textContent = `${state.deptKey} ¬∑ Orari`;

        const p = document.createElement('div');
        p.innerHTML = `
            <div><strong>Corso:</strong> ${escapeHtml(courseName)}</div>
            <div><strong>Anno:</strong> ${escapeHtml(String(year))}</div>
            <div style="margin-top:0.75em;">
                Pagina orari: <em>da implementare</em>.
            </div>
        `;
        el.pageArea.appendChild(p);

        const back = makeBackButton(() => renderCourseYearForm());
        back.style.marginTop = '1em';
        el.pageArea.appendChild(back);
    }

    function renderGruppiPage({ courseId, courseName, year, yearObj }) {
        showMainHeader(false);
        el.formArea.style.display = 'none';
        el.pageArea.style.display = 'block';
        clear(el.pageArea);

        el.title.textContent = `${state.deptKey} ¬∑ Gruppi WZ`;

        const groups = Array.isArray(yearObj?.groups) ? yearObj.groups : [];

        const wrap = document.createElement('div');
        wrap.innerHTML = `
            <div><strong>Corso:</strong> ${escapeHtml(courseName)}</div>
            <div><strong>Anno:</strong> ${escapeHtml(String(year))}</div>
        `;
        el.pageArea.appendChild(wrap);

        if (!groups || groups.length === 0) {
            const info = document.createElement('div');
            info.style.marginTop = '0.75em';
            info.innerHTML = `Gruppi WhatsApp: <em>non disponibili</em>.`;
            el.pageArea.appendChild(info);
        } else {
            const btnWrap = document.createElement('div');
            btnWrap.style.marginTop = '0.75em';
            btnWrap.style.display = 'flex';
            btnWrap.style.flexDirection = 'column';
            btnWrap.style.gap = '0.75em';

            groups.forEach((g, idx) => {
                const label = g?.name || `Gruppo ${idx + 1}`;
                btnWrap.appendChild(makeLinkButton(label, g?.link));
            });

            el.pageArea.appendChild(btnWrap);
        }

        const back = makeBackButton(() => renderCourseYearForm());
        back.style.marginTop = '1em';
        el.pageArea.appendChild(back);
    }

    function escapeHtml(s) {
        return String(s)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('\"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    async function init() {
        try {
            const res = await fetch('./info.json', { cache: 'no-store' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            state.data = await res.json();
            renderDeptButtons();
        } catch (err) {
            console.error(err);
            el.title.textContent = 'Errore';
            clear(el.actions);
            el.actions.appendChild(makeButton('Riprova', () => init()));
            const msg = document.createElement('div');
            msg.style.marginTop = '0.75em';
            msg.style.color = '#333';
            msg.textContent = 'Impossibile caricare info.json. Controlla che il file esista e sia valido.';
            el.actions.appendChild(msg);
        }
    }

    init();
</script>
</body>
</html>